<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Challenges</title>
	
	
    <style>
	/* General body style: centers everything, sets background image and font */
	body {
		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
		margin: 0;
		padding: 0;
		display: flex;
		justify-content: center;
		align-items: center;
		min-height: 100vh;
		background-color: #f0f2f5;
		background-image: url('uniPic.jpg'); /* Background image */
		background-size: cover;
		background-position: center;
	}

	/* Main container holding the entire content */
	.main-container {
		width: 98%;
		background-color: rgba(255, 253, 245, 0.95); /* Slightly transparent white */
		border-radius: 10px;
		box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
		padding: 8px;
		box-sizing: border-box;
	}

	/* Main title styling */
	.title {
		color: #003366;
		font-size: clamp(24px, 3vw, 32px);
		font-weight: 700;
		text-align: left;
		margin-bottom: 1px;
	}

	/* Divider line under the title */
	.divider {
		width: 100%;
		height: 3px;
		margin: 5px 0 10px 0;
		border: none;
		background: linear-gradient(to right, #555 0%, #999 30%, transparent 100%);
	}

	/* Box for each quest */
	.quest {
		background-color: rgba(255, 253, 245, 0.95);
		padding: 10px;
		border-radius: 10px;
		box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
		margin-bottom: 10px;
	}

	/* Quest heading */
	.quest h3 {
		margin: 0;
		color: #0033cc;
	}

	/* Quest description text */
	.quest p {
		margin: 5px;
		color: #000000;
	}

	/* Progress bar container */
	.progress-bar {
		width: 100%;
		height: 10px;
		background-color: #e0e0e0;
		border-radius: 5px;
		margin-top: 10px;
		overflow: hidden;
	}

	/* Filled portion of the progress bar */
	.progress {
		height: 100%;
		background-color: #28a745;
		width: 0;
		transition: width 0.3s ease;
	}

	/* Container for action buttons */
	.actions {
		margin-top: 20px;
		display: flex;
		justify-content: center;
	}

	/* Button styling */
	.actions button {
		padding: 10px 10px;
		font-size: 20px;
		background-color: #007bff;
		color: white;
		border: none;
		border-radius: 10px;
		cursor: pointer;
	}

	/* Button hover effect */
	.actions button:hover {
		background-color: #0056b3;
	}

	/* Scanner popup box */
	#qr-scanner {
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 90%;
		max-width: 400px;
		background-color: #f0f2f5;
		border-radius: 10px;
		box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
		display: none;
		z-index: 1000;
	}

	/* Scanner video feed */
	#qr-scanner video {
		width: 100%;
		border-radius: 10px 10px 0 0;
		box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
	}

	/* Top bar of the scanner window */
	.scanner-header {
		display: flex;
		justify-content: flex-end;
		padding: 10px;
		background-color: #f4f4f9;
		border-radius: 10px 10px 0 0;
	}

	/* Close button for scanner */
	.close-scanner {
		background: none;
		border: none;
		font-size: 25px;
		cursor: pointer;
		color: #000000;
	}

	.close-scanner:hover {
		color: #ff0000;
	}

	/* Message that appears after completing a quest */
	.completed-message {
		position: fixed;
		top: 20px;
		left: 50%;
		transform: translateX(-50%);
		background-color: #f0f2f5;
		color: white;
		padding: 10px 20px;
		border-radius: 10px;
		box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
		z-index: 1001;
		display: none;
	}

	/* Popup modal for rewards */
	#custom-modal {
		display: none; 
		position: fixed;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		background-color: white;
		padding: 40px; /* Increase padding for more internal space */
		width: 80%; /* Increase width (you can change the percentage or use px, e.g., 600px) */
		max-width: 800px; /* You can set a maximum width */
		height: 400px; /* Set a fixed height if you want */
		border-radius: 10px;
		box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
		z-index: 1002;
	}

	/* Modal button */
	#custom-modal button {
		margin-top: 10px;
		padding: 5px 10px;
		background-color: #007bff;
		color: white;
		border: none;
		border-radius: 5px;
		cursor: pointer;
	}



	/* Container for completed quest texts */
	#completed-quests {
		margin-top: 20px;
		width: 100%;
		max-width: 600px;
	}

	/* Green text shown permanently after completing a quest */
	.permanent-text {
		color: #28a745;
		font-weight: bold;
		margin-top: 10px;
		padding: 10px;
		background-color: #e8f5e9;
		border-radius: 5px;
		border: 1px solid #28a745;
		box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
	}
    </style>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body>
    <div class="main-container">

        <div class="header">
            <h1 class="title">Begin The Challenges</h1>
            <hr class="divider">
        </div>
		
		       
        <div class="container-text" id="text-content">
            <p>Follow the instructions in each challenge to unlock exciting rewards. 
			   Use the button at the bottom of the page to scan any QR code and get started!</p>
        </div>
		
        <div class="quest-container" id="active-quests"></div>
        <div class="quest-container" id="completed-quests"></div>

        <div class="actions">
            <button onclick="startQRScanner()">Scan & Earn Rewards</button>
        </div>

        <div id="qr-scanner">
            <div class="scanner-header">
                <button class="close-scanner" onclick="closeQRScanner()">Ã—</button>
            </div>
            <div id="qr-reader"></div>
        </div>

        <div id="completed-message" class="completed-message"></div>

        <div id="custom-modal">
            <p id="modal-message"></p>
            <button onclick="closeModal()">OK</button>
        </div>

        <div id="backdrop"></div>
    </div>



<script>
    const quests = [
        {
            id: 1,
            name: "Campus Scavenger Hunt",
            description: "Scan QR codes at 4 different locations to complete the hunt.",
            locations: ["MI Building", "MA Building", "MC Building", "MD Building"],
            completedLocations: [],
            reward: "Explorer Badge",
            isCompleted: false,
        },
        {
            id: 2,
            name: "Talk to University Members",
            description: "Talk to 5 University members and scan their QR codes to earn a free coffee coupon.",
            locations: [],
            completedLocations: [],
            reward: "Free Coffee Coupon. Say the word 'Best Uni' to the staff member of the cafeteria to get a free Cappucino.",
            isCompleted: false,
        },
        {
            id: 3,
            name: "First University Lecture",
            description: "Go to MC001 for the first ever lecture of your life. Scan the QR provided to learn a secret of the university.",
            locations: ["MC001"],
            completedLocations: [],
            reward: "University Secret. University of Wolverhampton have 20 computer LABs.",
            isCompleted: false,
        },
        {
            id: 4,
            name: "Teacher Talk",
            description: "Go to room MA212 and talk to Professor Hiran Patel about your future goals. After the talk, the professor will give you a word to log in to the computer and create your first game with the help of the previous student.",
            locations: ["MA212"],
            completedLocations: [],
            reward: "Game Development Access. Word to login to computer:'Unity'. ",
            isCompleted: false,
        },
    ];

    let html5QrCode;

    function saveQuestsToCache() {
        localStorage.setItem("quests", JSON.stringify(quests));
    }

    function loadQuestsFromCache() {
        const cached = localStorage.getItem("quests");
        if (cached) {
            const parsed = JSON.parse(cached);
            parsed.forEach((cachedQuest, i) => {
                quests[i].completedLocations = cachedQuest.completedLocations;
                quests[i].isCompleted = cachedQuest.isCompleted;
            });
        }
    }

    function checkQuestCompletion(quest) {
        if (
            (quest.id === 1 && quest.completedLocations.length === quest.locations.length) ||
            (quest.id === 2 && quest.completedLocations.length === 5) ||
            (quest.id === 3 && quest.completedLocations.length === 1) ||
            (quest.id === 4 && quest.completedLocations.length === 1)
        ) {
            quest.isCompleted = true;
            triggerFireworks();
            setTimeout(() => {
                awardReward(quest.reward);
                addPermanentText(quest.name);
                saveQuestsToCache();
                displayQuests();
            }, 2000);
        } else {
            saveQuestsToCache();
            displayQuests();
        }
    }

    function addPermanentText(questName) {
        const completedQuestsContainer = document.getElementById("completed-quests");
        if ([...completedQuestsContainer.children].some(el => el.textContent.includes(questName))) {
            return;
        }
        const permanentText = document.createElement("div");
        permanentText.className = "permanent-text";
        permanentText.textContent = `Challenge Completed: ${questName}`;
        completedQuestsContainer.appendChild(permanentText);
    }

    function awardReward(reward) {
        const modal = document.getElementById("custom-modal");
        const backdrop = document.getElementById("backdrop");
        const modalMessage = document.getElementById("modal-message");
        modalMessage.textContent = `Congratulations! You earned the ${reward}`;
        modal.style.display = "block";
        backdrop.style.display = "block";
    }

    function closeModal() {
        const modal = document.getElementById("custom-modal");
        const backdrop = document.getElementById("backdrop");
        modal.style.display = "none";
        backdrop.style.display = "none";
    }

    function triggerFireworks() {
        confetti({
            particleCount: 100,
            spread: 100,
            origin: { y: 0.6 },
        });
    }

    function processQRCode(qrContent) {
        const scavengerHuntQuest = quests.find(q => q.id === 1);
        if (scavengerHuntQuest && !scavengerHuntQuest.isCompleted && scavengerHuntQuest.locations.includes(qrContent)) {
            if (!scavengerHuntQuest.completedLocations.includes(qrContent)) {
                scavengerHuntQuest.completedLocations.push(qrContent);
                checkQuestCompletion(scavengerHuntQuest);
                return;
            } else {
                alert(`You've already scanned the QR code for ${qrContent}.`);
            }
        }

        const memberQuest = quests.find(q => q.id === 2);
        if (memberQuest && !memberQuest.isCompleted && qrContent.toLowerCase() === "member") {
            memberQuest.completedLocations.push("Member QR");
            checkQuestCompletion(memberQuest);
            return;
        }

        const firstLectureQuest = quests.find(q => q.id === 3);
        if (firstLectureQuest && !firstLectureQuest.isCompleted && qrContent === "MC001") {
            firstLectureQuest.completedLocations.push("MC001");
            checkQuestCompletion(firstLectureQuest);
            return;
        }

        const teacherTalkQuest = quests.find(q => q.id === 4);
        if (teacherTalkQuest && !teacherTalkQuest.isCompleted && qrContent === "MA212") {
            teacherTalkQuest.completedLocations.push("MA212");
            checkQuestCompletion(teacherTalkQuest);
            return;
        }

        saveQuestsToCache();
        displayQuests();
    }

    function displayQuests() {
        const activeQuestsContainer = document.getElementById("active-quests");
        activeQuestsContainer.innerHTML = "";

        quests.forEach(quest => {
            if (!quest.isCompleted) {
                const questElement = document.createElement("div");
                questElement.className = "quest";
                questElement.innerHTML = `
                    <h3>${quest.name}</h3>
                    <p>${quest.description}</p>
                    <p>Progress: ${quest.completedLocations.length}/${quest.id === 2 ? 5 : quest.locations.length}</p>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${(quest.completedLocations.length / (quest.id === 2 ? 5 : quest.locations.length)) * 100}%"></div>
                    </div>
                `;
                activeQuestsContainer.appendChild(questElement);
            } else {
                addPermanentText(quest.name);
            }
        });
    }

    function startQRScanner() {
        const qrScannerDiv = document.getElementById("qr-scanner");
        qrScannerDiv.style.display = "block";

        html5QrCode = new Html5Qrcode("qr-reader");
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            html5QrCode.stop().then(() => {
                qrScannerDiv.style.display = "none";
                processQRCode(decodedText);
            }).catch(err => {
                console.error("Failed to stop the QR scanner:", err);
            });
        };

        const config = { fps: 10, qrbox: 250 };
        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
            .catch(err => {
                console.error("Failed to start the QR scanner:", err);
                alert("Failed to start the QR scanner. Please ensure you have a camera and try again.");
                qrScannerDiv.style.display = "none";
            });
    }

    function closeQRScanner() {
        const qrScannerDiv = document.getElementById("qr-scanner");
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                qrScannerDiv.style.display = "none";
            }).catch(err => {
                console.error("Failed to stop the QR scanner:", err);
            });
        } else {
            qrScannerDiv.style.display = "none";
        }
    }

    // Load progress from cache and display quests on page load
    loadQuestsFromCache();
    displayQuests();
</script>
</body>
</html>